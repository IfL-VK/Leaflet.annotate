/**
    This is leaflet.annotate-0.3.0-SNAPSHOT
    Author: Malte Rei√üig 
    Project Page: https://mukil.github.io/Leaflet.annotate 
    API Documentation:, https://github.com/mukil/Leaflet.annotate#readme **/

var SCHEMA_ORG="http://schema.org/",articleElements=[],metaElements=[],metadataElements=[],annotatedElements=[],typeCount=[];L.Control.AnnotationViewer=L.Control.extend({options:{position:"topright",placeholder:"Search..."},initialize:function(a){L.Util.setOptions(this,a)},onAdd:function(a){var b=L.DomUtil.create("div","annotation-viewer search-container");this.a=L.DomUtil.create("a","leaflet-control-annotation-viewer"),this.a.innerHTML='<img src="css/readerView-Icon-decentblue-transparent.png" title="Launch Annotation Reader">';var c=this._toggleAnnotationViewer,d=this;return this.a.onclick=function(a){c(d,b)},b.appendChild(this.a),b},onRemove:function(a){L.DomEvent.removeListener(this._input,"keyup",this.keyup,this),L.DomEvent.removeListener(form,"submit",this.submit,this)},keyup:function(a){if(38===a.keyCode||40===a.keyCode);else if(this.input.value.length>2){var b=this.input.value,c=this._searchAnnotationsByName(b);this._renderResultItems(c,this)}},typeGroupSelected:function(a){var b=this._buildTypeSearchResults(a.target["data-type-uri"]);this.results=document.querySelector(".list-group"),this._renderResultItems(b,this)},itemSelected:function(a){L.DomEvent.preventDefault(a);var b=a.target,c=(b.innerHTML,b.getAttribute("data-result-list-id")),d=Array.from(document.querySelectorAll('[data-internal-leaflet-id="'+c+'"]')),e=void 0;this.input.value=b.getAttribute("data-result-name");for(var f in d){var g=d[f];if(e=this._getCoordinatesOfFirstGeoChildProperty(g))break}if(!e||e.coordinates.length>=3)console.warn("Unsupported Coordinate Value Pair",e.coordinates,"currently just buonding box (2 values) or a Point (1 value) are supported");else if(1===e.coordinates.length){var h=e.coordinates[0];this._map.panTo(L.latLng(h.lat,h.lng))}else if(2===e.coordinates.length){var i=e.coordinates[0],j=e.coordinates[1],k=L.latLngBounds(i,j);this._map.fitBounds(k)}this._renderItemInfoFields(d)},submit:function(a){console.log("Submitted Query",a),L.DomEvent.preventDefault(a)},_renderItemInfoFields:function(a){console.log("Show Metadata for Map Element",a);var b=document.querySelector("div.form-group"),c=document.querySelector("div.metadata-group"),d=document.querySelector("div.list-group");if(null==c&&a[0].childNodes.length>0){c=L.DomUtil.create("div","metadata-group",b);var e=window.innerHeight-35,f=e/2;d.setAttribute("style","height:"+(f-35)+"px"),c.setAttribute("style","height: "+f+"px; min-height: "+f+"px"),L.DomEvent.addListener(c,"wheel",function(a){console.log("WheelScroll",a),L.DomEvent.preventDefault(a),L.DomEvent.stopPropagation(a)}),L.DomEvent.addListener(c,"drag",function(a){L.DomEvent.preventDefault(a),L.DomEvent.stopPropagation(a)})}c.innerHTML="";var g=void 0,h=a[0].getAttribute("itemtype");if(h){var i=h.substr(SCHEMA_ORG.length),j=this._createSpanInfoField("Type",i);c.appendChild(j),c.appendChild(document.createElement("br"))}for(var k in a[0].childNodes){var l=a[0].childNodes[k];if(l.attributes&&l.attributes.hasOwnProperty("content")){var m=l.getAttribute("name"),n=l.getAttribute("itemprop"),o=l.getAttribute("content"),p=void 0;"http://purl.org/dc/terms/created"===m?p=this._createSpanInfoField("Created",new Date(o)):"http://purl.org/dc/terms/modified"===m?p=this._createSpanInfoField("Modified",new Date(o)):"http://purl.org/dc/elements/1.1/date"===m?p=this._createSpanInfoField("Published",new Date(o)):"http://purl.org/dc/elements/1.1/creator"===m?p=this._createSpanInfoField("Creator",o):"http://purl.org/dc/elements/1.1/contributor"===m?p=this._createSpanInfoField("Contributor",o):"http://purl.org/dc/elements/1.1/publisher"===m?p=this._createSpanInfoField("Publisher",o):"http://purl.org/dc/elements/1.1/rights"===m?p=this._createSpanInfoField("Usage Rights",o):"http://purl.org/dc/elements/1.1/source"===m?p=this._createSpanInfoField("Source",o):"url"===n?g=o:"description"===n&&(p=this._createSpanInfoField(void 0,"<p>"+o+"</p>")),p&&(c.appendChild(p),c.appendChild(document.createElement("br")))}}g&&(p=document.createElement("a"),p.text="Browse Source",p.setAttribute("href",g),p.setAttribute("class","metadata-field datasource"),p.setAttribute("title","Visit the source of information for this web map element"),c.appendChild(p))},_createSpanInfoField:function(a,b){if(field=document.createElement("div"),field.setAttribute("class","metadata-field"),a){var c=document.createElement("span");c.setAttribute("class","header"),c.innerHTML=a,field.appendChild(c)}var d=document.createElement("span");return d.setAttribute("class","value"),d.innerHTML=b,field.appendChild(d),field},_renderResultItems:function(a,b){var c=window.innerHeight-35,d=c-35,e=document.querySelector("div.metadata-group");if(null!=e&&(d-=c/2),b.containerRef.setAttribute("style","height:"+c+"px"),b.results.setAttribute("style","height:"+d+"px"),b.results.innerHTML="",a.length>0){var f=a[0];f.type?b.results.innerHTML='<span class="header">'+a.length+"x "+f.type+"</span>":b.results.innerHTML='<span class="header">'+a.length+" items found</span>"}for(var g in a){var h=a[g],i=L.DomUtil.create("a","list-group-item");i.href="",i.title='Focus "'+h.name+'" ('+h.leafletId+") in map",i.setAttribute("data-result-parent-item-type",h.type),i.setAttribute("data-result-name",h.name),i.setAttribute("data-result-list-id",h.leafletId),i.innerHTML=h.name,b.results.appendChild(i),L.DomEvent.addListener(i,"click",b.itemSelected,b),L.DomEvent.disableClickPropagation(i)}L.DomEvent.addListener(b.results,"wheel",function(a){a.target.className.indexOf("list-group-item")!=-1&&(a.target.parentNode.scrollTop+=a.deltaY),L.DomEvent.preventDefault(a),L.DomEvent.stopPropagation(a)},b)},_toggleAnnotationViewer:function(a,b){if(1===b.children.length){a._buildAnnotatedElementsCache(),b.children[0].innerHTML="X";for(var c in typeCount){var d=c.slice(SCHEMA_ORG.length),e=L.DomUtil.create("a","type-group-item");e.href="#"+d,e["data-type-uri"]=c,e.title='Show all items of type "'+d+'"',e.innerHTML=typeCount[c].count,b.appendChild(e),L.DomEvent.addListener(e,"click",a.typeGroupSelected,a),L.DomEvent.disableClickPropagation(e)}a.form=L.DomUtil.create("form","form",b);var f=L.DomUtil.create("div","form-group",a.form);a.input=L.DomUtil.create("input","form-control input-sm",f),a.input.type="text",a.input.placeholder=a.options.placeholder,a.input.focus(),a.results=L.DomUtil.create("div","list-group",f),a.containerRef=b,L.DomUtil.addClass(b,"selected"),L.DomEvent.addListener(a.input,"keyup",a.keyup,a),L.DomEvent.addListener(a.form,"submit",a.submit,a)}else{b.children[0].innerHTML='<img src="css/readerView-Icon-decentblue-transparent.png" title="Launch Annotation Reader">';var g=Array.from(b.children);for(var h in g)"form"!==g[h].localName&&g[h].className.indexOf("type-group-item")==-1||b.removeChild(g[h]);L.DomUtil.removeClass(b,"selected")}},_buildAnnotatedElementsCache:function(){articleElements=Array.from(document.querySelectorAll("article")),metaElements=Array.from(document.querySelectorAll("meta")),metadataElements=Array.from(document.querySelectorAll("metadata")),typeCount=[];for(var a in articleElements){var b=articleElements[a].getAttribute("itemtype");annotatedElements.push(articleElements[a]),this._countTypeInstances(b)}for(var c in metadataElements){var d=metadataElements[c].getAttribute("itemtype");annotatedElements.push(metadataElements[c]),this._countTypeInstances(d)}console.log("Repopulating Annotated Elements Cache, Found",metaElements.length,"annotations over",articleElements.length+metadataElements.length,"elements overall (",articleElements.length,"article and",metadataElements.length,"metadata elements)")},_countTypeInstances:function(a){void 0===typeCount[a]?typeCount[a]={count:1}:typeCount[a]={count:typeCount[a].count+1}},_buildTypeSearchResults:function(a){var b=[],c=Array.from(document.querySelectorAll('[itemtype="'+a+'"]'));for(var d in c){var e=Array.from(c[d].children),f={name:"No name given",type:a.slice(SCHEMA_ORG.length),node:c[d],leafletId:c[d].getAttribute("data-internal-leaflet-id")};for(var g in e){var h=e[g],i=h.getAttribute("itemprop");h.getAttribute("name");if(h.attributes.hasOwnProperty("content")){var j=h.getAttribute("content");"name"===i&&j.length>0?f.name=j:"sameAs"===i?f.sameAs=j:"url"===i&&(f.url=j)}}this._addToResults(b,f)}return b},_getCoordinatesOfFirstGeoChildProperty:function(a){var b=Array.from(a.children);for(var c in b){var d=b[c],e=d.getAttribute("itemprop"),f={};if("geo"===e||"location"===e||"birthPlace"===e||"deathPlace"===e||"contentLocation"===e||"locationCreated"===e||"homeLocation"===e||"workLocation"===e)return f.property=e,f.coordinates=this._parseGeoCoordinateValuePairs(d),f}},_parseGeoCoordinateValuePairs:function(a){var b=a.getAttribute("itemtype"),c=[];"http://schema.org/GeoCoordinates"===b?c=Array.from(a.children):"http://schema.org/Place"===b?c=Array.from(a.children[0].children):console.warn("Focussing Geo Shape values or other itemtypes than Place and GeoCoordinates - NOT YET IMPLEMENTED");var d=[],e={};for(var f in c){var g=c[f],h=g.getAttribute("itemprop");"latitude"===h?e.lat=g.getAttribute("content"):"longitude"===h&&(e.lng=g.getAttribute("content"))}if(e.hasOwnProperty("lat")&&e.hasOwnProperty("lng"))return d.push(e),d;for(var f in c){var g=c[f],h=g.getAttribute("itemprop");if("box"===h){var i=g.getAttribute("content"),j=i.split(" ")[0],k=i.split(" ")[1];d.push({lat:j.split(",")[0],lng:j.split(",")[1]}),d.push({lat:k.split(",")[0],lng:k.split(",")[1]})}}return d},_searchAnnotationsByName:function(a){var b=[];for(var c in metaElements){var d=metaElements[c],e=d.getAttribute("itemprop"),f=d.getAttribute("name");if("name"===e||"description"===e||"http://purl.org/dc/elements/1.1/creator"===f){var g=d.getAttribute("content");g.toLowerCase().indexOf(a.toLowerCase())!=-1&&(d.type=d.parentNode.getAttribute("itemtype").slice(SCHEMA_ORG.length),d.name=g,d.leafletId=d.parentNode.getAttribute("data-internal-leaflet-id"))}this._addToResults(b,d)}return b},_addToResults:function(a,b){for(var c in a){var d=a[c];if(d.leafletId===b.leafletId)return;if(d.hasOwnProperty("url")&&b.hasOwnProperty("url")&&d.url===b.url)return;if(d.hasOwnProperty("identifier")&&b.hasOwnProperty("identifier")&&d.identifier===b.identifier)return;if(d.hasOwnProperty("sameAs")&&b.hasOwnProperty("sameAs")&&d.sameAs===b.sameAs)return}a.push(b)}}),L.control.annotationViewer=function(a,b){return new L.Control.AnnotationViewer(a,b)};